# INFRA - 20190411

cloud computing : 단말기 통해서는 입출력만 하고, 다른 처리는 모두 클라우드라고 불리는 제 3의 공간에서 이루어지는 시스템 형태.


## 리눅스(Cent OS) 가상서버 생성 및 연결

새로운 가상서버 만들기

1. 새 하드디스크를 만들기 전, ip를 할당받아야 한다.
네트워크 -> 네트워크 들어가서
설계하고자 하는 서브넷 주소와 게이트웨이, DNS서버도 입력한다.

2. ip할당 후 기존에 있는 외부 네트워크와 연결시켜 주기 위해 라우터를 생성한다. 

3. 라우터 생성 후 인터페이스로 이 둘을 연결해준다.

4. 보안그룹을 생성한다. 테스트를 위한 서버므로, 

		모든 포트에 대한 ICMP, UDP, TCP 인바운드 허용한다.


5. 유동ip 할당하고 기다린다.

6. default centos로 인스턴스 생성한다.
------------------------------------------------------------------------------------------------------

기존의 시스템에 새 볼륨을 연결하고 마운트 하기

볼륨 생성하고 연결해준다.
근데 아직 마운트 된 것이 아니기때문에 해줘야함

fdisk /dev/vdb -> vdb에 새로운 파티션을 할당을 시작한다.
	
m입력시 help나옴

n -> 파티션 할당해준다.

default
default first실린더
default last실린더

mkfs.xfs /dev/vdb1  -> vdb1을 포맷한다.

mount -v /dev/vdb1 /data/  /data 경로에 스토리지 마운트시킴

-------------------------------------------------------------------------------
기본적으로 centOS는 selinux옵션이 켜져있다.
이를 테스트 해보자.
그냥 /var/www/html에 파일을 만들면 웹상에서 바로 조회가 가능하지만, 
/폴더에서 파일을 생성 후 옮겨서 웹상에서 조회하면 403 forbidden error가 난다.
selinux옵션으로 인해 생성된 보안 그룹이 다르기 때문에 볼 수 없는 것이다.

chcon --reference=aaaa.html test2.html
-> 처음 생성한 aaaa.html의 보안그룹을 test2.html에 적용시킨다.

이 명령어를 실행시키면, test2.html도 aaaa.html와 같은 보안그룹으로 바뀌어 웹상에서
조회가 가능하다.

근데 이거 매번 지키기 귀찮으니 selinux옵션을 해제한다.

/etc/selinux/config에서
SELIUNX=disalbed -> 보안그룹을 안쓰겠다! 선언함.

getenforce -> selinux옵션을 쓰는지 확인 하는 명령어임!

해제하고 다른 폴더에서 생성한 파일을 www/html에 옮겨서 써도 작동안된다. 왜지?
selinux설정한거를 아직 설정안해줌.
리스타트 해주면 된다. -> systemctl restart httpd -> http 데몬을 재실행시킨다.

그런데 로그아웃 하고 다시 접속하면 마운트 된 스토리지가 없어져 있다. 이를 계속 마운트 된 상태로 지속하기 위해서 작업을 해보겠다.

blkid -> 시스템 상 존재하는 하드웨어의 uuid를 볼 수 있다.

이 명령어에서 본 uuid를 복사해놓자.
vi /etc/fstab으로 파일을 연 다음, /dev/vda1 밑에 새로 이 문장을 기입하자.
UUID=f4d43618-5859-434f-9c13-a83bd8e81239 /data                   xfs     defaults        0 0

이렇게 함으로써 시스템에 디폴트로 마운트 되게 만들었다.
이를 적용시키기 위해  mount -av 명령어를 터미널에 입력하면,

	/                        : ignored
	/data                    : successfully mounted

라고 뜨는데 , 
기존 "/" 경로는 이미 디폴트로 마운트 되어있기 때문에 한번 더 마운트 할 수 없다.
그러므로 ignored뜨고, 새 볼륨 /dev/vdb1을 방금 /data에 마운트 시켰기 때문에
성공적으로 마운트 되었다고 로그가 뜬다.

이를 최종적으로 적용시키기 위해 시스템을 재시작해보자.

재시작후 mount 명령어를 입력하면 모든 마운트 된 장치들이 뜬다. 밑에부분을 보면, 

	nfsd on /proc/fs/nfsd type nfsd (rw,relatime)
	/dev/vdb1 on /data type xfs (rw,relatime,attr2,inode64,noquota)
	tmpfs on /run/user/1000 type tmpfs (rw,nosuid,nodev,relatime,size=101596k,mode=700,uid=1000,gid=1000)

라고 뜬다. 

윈도우 가상서버(2012R2) 생성 및 연결
-----------------------------------------------
기존에 우리는 윈도우 이미지를 넣은 볼륨을 만들어놨다.

생성시 부팅 소스를 볼륨으로 하고 만들어 놓은 볼륨으로 인스턴스를 생성한다. 

flavor를 느낌표 뜨는거 말고 젤 큰걸로 할당하자.

이거는 빨리 spawning까지 완료된다.
콘솔 드가보면 우리가 흔히 보는 윈도우 창이 나온다.

오른쪽 위에 SendAlTDel 버튼 누르면 암호치는 화면 나온다.
근데 윈도우 암호를 설정한 적 없다... 
사실 openstack이 인스턴스 생성시 랜덤한 암호를 생성한 상태다
이를 알기 위해 인스턴스 메인에서 작업 -> 비밀번호 들어가면, 
암호화된 암호를 볼수있다... 이를 우리가 이전에 받아놓은 키페어를 이용하여 해독하자.

복붙이 안되니까 메모장에 옮겨놓고 다시 콘솔 드가서 비번 입력하면 이상한 창이 하나 뜸.
기다리면 된다.

윈도우에서 원격접속을 할때 RDP프로토콜(포트번호 3389)을 보안그룹가서 허용해주자.

뜨면 비번부터 바꿔주고, 방화벽 설정을 끄고, 원격접속 허용한다.
이거가지고 mstsc 실행해서 원격접속함

원격접속해서 같은 네트워크 상의 리눅스 서버로 핑보내면 응답이 없다.
보안 규칙에 브로드캐스트가 없기 때문에 응답이 없는 것이다.
이를 추가해주자.
규칙추가 -> ALL TCP -> 원격-보안그룹 -> 보안그룹은 현재       추가하면 된다.

추가하고 private ip address로 접속하면 드디어 작동한다!